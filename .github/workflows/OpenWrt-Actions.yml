#
#
# æ„Ÿè°¢p3terxå¤§ç¥çš„ä¸€é”®ç¼–è¯‘è„šæœ¬
# 
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# <https://github.com/P3TERX/Actions-OpenWrt.git>
#


name: ç¼–è¯‘OpenWrtå›ºä»¶

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'build-openwrt'
        required: true
        default: 'ç¼–è¯‘OpenWrtå›ºä»¶'


# å®šæ—¶è§¦å‘ç¼–è¯‘(æ¯å¤©æ—©5ç‚¹)
  schedule:
    - cron: 0 21 * * *

# ç‚¹èµâ˜†Starè§¦å‘ç¼–è¯‘
#  watch:
#    types: [started]

# ç¼–è¾‘è§¦å‘
  push:
    branches:
      - master
    paths:
      - 'å¼€å¯ç¼–è¯‘'

env: 
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  SCKEY: ${{ secrets.WEIXIN_SCKEY }}
  GITHUB_RELEASE: https://github.com/db-one/OpenWrt-AutoBuild/releases
  TZ: Asia/Shanghai

jobs: 
  build:
    runs-on: ubuntu-18.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: ç¼–è¯‘ ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [Lean_x86_64,Lienol_x86_64,Lean_x86_64_Long,Lienol_x86_64_Long]  #[Lean_x86_64,Lienol_x86_64,Lean_x86_64_Long,Lienol_x86_64_Long]

    steps:
    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@v2

    - name: æ£€æµ‹è„šæœ¬è®¾ç½®
      run: |
        source "${GITHUB_WORKSPACE}/build/${{matrix.target}}/settings.ini"
        echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
        echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
        echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
        echo "WXFB_MESSAGE=${WXFB_MESSAGE}" >> $GITHUB_ENV
        echo "CUSTOM_SH=${CUSTOM_SH}" >> $GITHUB_ENV
        echo "SSH_ACTIONS=${SSH_ACTIONS}" >> $GITHUB_ENV
        echo "UPLOAD_FIRMWARE=${UPLOAD_FIRMWARE}" >> $GITHUB_ENV
        echo "UPLOAD_VMDK=${UPLOAD_VMDK}" >> $GITHUB_ENV
        echo "UPLOAD_IPK=${UPLOAD_IPK}" >> $GITHUB_ENV
        echo "UPLOAD_CONFIG=${UPLOAD_CONFIG}" >> $GITHUB_ENV
        echo "UPLOAD_COWTRANSFER=${UPLOAD_COWTRANSFER}" >> $GITHUB_ENV
        echo "UPLOAD_WETRANSFER=${UPLOAD_WETRANSFER}" >> $GITHUB_ENV
        echo "UPLOAD_RELEASE=${UPLOAD_RELEASE}" >> $GITHUB_ENV
        echo "SERVERCHAN_SCKEY=${SERVERCHAN_SCKEY}" >> $GITHUB_ENV

    - name: å¼€å§‹å®‰è£…ç¼–è¯‘æ‰€éœ€ç³»ç»Ÿ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install $(curl -fsSL git.io/depends-ubuntu-1804)
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: ä¸‹è½½${{matrix.target}}æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone -b $REPO_BRANCH --single-branch $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
      id: date
      run: |
        sudo timedatectl set-timezone "$TZ"
        echo "::set-output name=status::success"
        echo "FILE_DATE=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
        echo "FILE_DATE1=$(date "+%Yå¹´%mæœˆ%då·-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
        echo "FILE_DATE2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV

    - name: åŠ è½½æº,å®šåˆ¶æ–‡ä»¶å¹¶ç”Ÿæˆè‡ªå®šä¹‰é…ç½®
      run: |
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æºç ç›®å½•
        cp -Rf `find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './'` openwrt
        cd openwrt

        echo "Apply Files..."
        if [ -n "$(ls -A "build/${{matrix.target}}/files" 2>/dev/null)" ]; then
         cp -rf build/${{matrix.target}}/files files
        fi
        if [ -n "$(ls -A "build/${{matrix.target}}/Source" 2>/dev/null)" ]; then
         cp -Rf build/${{matrix.target}}/Source/* ./
        fi

        echo "Apply Custom"
        if [ -f "build/${{matrix.target}}/$CUSTOM_SH" ]; then
        (
          chmod +x build/${{matrix.target}}/$CUSTOM_SH
          /bin/bash "build/${{matrix.target}}/$CUSTOM_SH"
        )
        fi
         mv build/${{matrix.target}}/$CONFIG_FILE .config
        make defconfig

    - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨é…ç½®å›ºä»¶
      uses: P3TERX/ssh2actions@v1.0.0
      if: env.SSH_ACTIONS == 'true' || contains(github.event.action, 'ssh')

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        cd openwrt && make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make -j$(($(nproc)+1)) || make -j1 V=s

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      run: |
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -hT
        echo "======================="
        du -h --max-depth=1 openwrt/ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 openwrt/build_dir
        du -h --max-depth=1 openwrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organizer
      run: |
        mkdir config
        find openwrt/bin/targets/ -name "*config.buildinfo*" | xargs -i mv -f {} config
        mkdir -p ./artifact/firmware
        mkdir -p ./artifact/vmware
        mkdir -p ./artifact/package
        mkdir -p ./artifact/buildinfo
        rm -rf $(find openwrt/bin/targets/ -type d -name "packages")
        cp -rf $(find openwrt/bin/packages/ -type f -name "*.ipk") ./artifact/package/
        cp -rf $(find openwrt/bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/
        cp -rf $(find openwrt/bin/targets/ -type f -name "*combined*img*") ./artifact/firmware/
        cp -rf $(find openwrt/bin/targets/ -type f -name "*combined*vmdk*") ./artifact/vmware/
        echo "::set-output name=status::success"

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_firmware_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/firmware/

    - name: ä¸Šä¼ vmwareé•œåƒæ–‡ä»¶
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_VMDK == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_vmware_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/vmware/

    - name: ä¸Šä¼ æ’ä»¶åŒ…æ–‡ä»¶
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_IPK == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_package_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/package/

    - name: ä¸Šä¼ å›ºä»¶é…ç½®ä¿¡æ¯
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_CONFIG == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_buildinfo_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/buildinfo/

    - name: ä¸Šä¼ å›ºä»¶åˆ° å¥¶ç‰›å¿«ä¼ 
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ./artifact/firmware/ 2>&1 | tee cowtransfer.log
        echo "::warning file=å¥¶ç‰›å¿«ä¼ ï¼ˆ${{matrix.target}}ï¼‰::$(cat cowtransfer.log | grep https)"

    - name: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ./artifact/firmware/ 2>&1 | tee wetransfer.log
        echo "::warning file=WeTransferï¼ˆ${{matrix.target}}ï¼‰::$(cat wetransfer.log | grep https)"
    
    - name: æå–å‘å¸ƒç”¨çš„ã€Œå¥¶ç‰›å¿«ä¼ ã€å’Œã€ŒWeTransferã€çš„é“¾æ¥
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ./artifact/firmware/ 2>&1 | tee cowtransfer.log
        echo "COWTRANSFER_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV 
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ./artifact/firmware/ 2>&1 | tee wetransfer.log
        echo "WETRANSFER_URL=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV 

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v1
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
      with:
        name: ${{ env.FILE_DATE1 }} ã€Œ ${{ env.WXFB_MESSAGE }} ã€å›ºä»¶
        tag_name: ${{ env.FILE_DATE2 }}-${{matrix.target}}
        body: |            
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜†  æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼
            
            ğŸ‰ [ ${{ env.WXFB_MESSAGE }} ]å›ºä»¶ä¸‹è½½ âœ¨
            
            ğŸ’ å¥¶ç‰›å¿«ä¼ (å›½å†…é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.COWTRANSFER_URL }}
            
            â›„ WeTransfer(å›½å¤–é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.WETRANSFER_URL }}
            
            ğŸŒ´ é“¾æ¥æœ‰æ•ˆæœŸä¸º7å¤©ï¼Œæ— éœ€æ³¨å†Œç›´æ¥ä¸‹è½½ ğŸ¤
            
            =========================================
            
        files: ./artifact/firmware/*

    - name: åˆ é™¤å·²å‘å¸ƒçš„è€å›ºä»¶
      uses: c-hive/gha-remove-artifacts@v1
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      with:
        age: '1 day'   #åˆ é™¤å¤šå°‘å¤©å‰çš„æ—§å›ºä»¶

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„è€å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      with:
        keep_latest: 12         #ä¿ç•™å¤šå°‘ä¸ªå‘å¸ƒä¸åˆ é™¤
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: å®Œæˆç¼–è¯‘å¾®ä¿¡é€šçŸ¥
      uses: emon100/Action-Serverchan@v2
      if: steps.organizer.outputs.status == 'success' && env.SERVERCHAN_SCKEY == 'true'
      with:
        SCKEY: ${{ secrets.WEIXIN_SCKEY }}
        text: æ­å–œ${{matrix.target}}å›ºä»¶ç¼–è¯‘æˆåŠŸï¼
        desp: æ‚¨çš„${{ env.WXFB_MESSAGE }}å›ºä»¶æˆåŠŸç¼–è¯‘å®Œæˆäº†ï¼

              
              å®Œæˆæ—¶é—´ï¼š${{ env.FILE_DATE1 }}
              
              
              å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}
              
              
              å¥¶ç‰›å¿«ä¼ ï¼š${{ env.COWTRANSFER_URL }}
              
              
              WeTransferï¼š${{ env.WETRANSFER_URL }}
              
              
              å›ºä»¶å·²ç»ç¼–è¯‘å®Œæˆ ğŸˆï¼ï¼ï¼
