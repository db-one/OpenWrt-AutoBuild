#
#
# æ„Ÿè°¢p3terxå¤§ç¥çš„ä¸€é”®ç¼–è¯‘è„šæœ¬
# 
# Copyright (C) 2019 P3TERX <https://p3terx.com>
# <https://github.com/P3TERX/Actions-OpenWrt.git>
#


name: ç¼–è¯‘OpenWrtå›ºä»¶

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'ç¼–è¯‘OpenWrtå›ºä»¶-SSHè¿œç¨‹ï¼šæ”¹ä¸ºâ€œsshâ€æ‰“å¼€SSHè¿æ¥'
        required: false
        default: 'ssh-actions'


# å®šæ—¶è§¦å‘ç¼–è¯‘(æ¯å¤©æ—©3ç‚¹)
  schedule:
    - cron: 0 19 * * *

# ç‚¹èµâ˜†Starè§¦å‘ç¼–è¯‘
#  watch:
#    types: [started]


env: 
  TZ: Asia/Shanghai
  GIT_USER_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
  WECHAT_WORK_URL: ${{ secrets.WECHAT_WORK_URL }}
  WECHAT_WORK_TOKEN: ${{ secrets.WECHAT_WORK_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  GITHUB_RELEASE: https://github.com/db-one/OpenWrt-AutoBuild/releases

jobs: 
  build:
    runs-on: Ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: ç¼–è¯‘ ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [Lean_x86_64,Lienol_x86_64,Lean_x86_64_Long,Lienol_x86_64_Long]  #[Lean_x86_64,Lienol_x86_64,Lean_x86_64_Long,Lienol_x86_64_Long]

    steps:
    - name: å‡†å¤‡å®Œæˆ
      uses: actions/checkout@v2

    - name: æ£€æµ‹è„šæœ¬è®¾ç½®
      run: |
        source "${GITHUB_WORKSPACE}/build/${{matrix.target}}/settings.ini"
        echo "REPO_URL=${REPO_URL}" >> $GITHUB_ENV
        echo "REPO_BRANCH=${REPO_BRANCH}" >> $GITHUB_ENV
        echo "CONFIG_FILE=${CONFIG_FILE}" >> $GITHUB_ENV
        echo "FIRMWARE_MESSAGE=${FIRMWARE_MESSAGE}" >> $GITHUB_ENV
        echo "CUSTOM_SH=${CUSTOM_SH}" >> $GITHUB_ENV
        echo "SSH_ACTIONS=${SSH_ACTIONS}" >> $GITHUB_ENV
        echo "UPLOAD_FIRMWARE=${UPLOAD_FIRMWARE}" >> $GITHUB_ENV
        echo "UPLOAD_VMDK=${UPLOAD_VMDK}" >> $GITHUB_ENV
        echo "UPLOAD_IPK=${UPLOAD_IPK}" >> $GITHUB_ENV
        echo "UPLOAD_CONFIG=${UPLOAD_CONFIG}" >> $GITHUB_ENV
        echo "UPLOAD_COWTRANSFER=${UPLOAD_COWTRANSFER}" >> $GITHUB_ENV
        echo "UPLOAD_WETRANSFER=${UPLOAD_WETRANSFER}" >> $GITHUB_ENV
        echo "UPLOAD_RELEASE=${UPLOAD_RELEASE}" >> $GITHUB_ENV
        echo "WECHAT_WORK_PUSH=${WECHAT_WORK_PUSH}" >> $GITHUB_ENV
        echo "TELEGRAM_BOT=${TELEGRAM_BOT}" >> $GITHUB_ENV

    - name: åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        docker rmi `docker images -q`
        sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
        sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* android*
        sudo -E apt-get update
        sudo -E apt-get -y install build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch python3 unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs gcc-multilib g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler antlr3 gperf swig libc6-dev-i386 libc6-dev libncurses5 libtinfo-dev libtinfo5 ncurses-doc python2.7 git-core wget curl rsync
        sudo -E apt-get -y autoremove --purge
        sudo -E apt-get clean

        df -h

        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    - name: ä¸‹è½½${{matrix.target}}æºç 
      working-directory: /workdir
      run: |
        df -hT $PWD
        git clone -b $REPO_BRANCH --single-branch $REPO_URL openwrt
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    - name: æ›´æ–°æ—¶åŒºã€ç¼–è¯‘æ—¶é—´
      id: date
      run: |
        sudo timedatectl set-timezone "$TZ"
        echo "::set-output name=status::success"
        echo "FILE_DATE=$(date +"%m-%d %H.%M")" >> $GITHUB_ENV
        echo "FILE_DATE1=$(date "+%Yå¹´%mæœˆ%dæ—¥-%Hç‚¹%Måˆ†")" >> $GITHUB_ENV
        echo "FILE_DATE2=$(date "+%Y%m%d-%H%M")" >> $GITHUB_ENV

    - name: åŠ è½½æº,å®šåˆ¶æ–‡ä»¶å¹¶ç”Ÿæˆè‡ªå®šä¹‰é…ç½®
      run: |
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æºç ç›®å½•
        cp -Rf `find ./ -maxdepth 1 -type d ! -path './openwrt' ! -path './'` openwrt
        cd openwrt

        echo "æ‰§è¡Œè„šæœ¬"
        if [ -f "build/${{matrix.target}}/$CUSTOM_SH" ]; then
        (
          chmod +x build/${{matrix.target}}/$CUSTOM_SH
          /bin/bash "build/${{matrix.target}}/$CUSTOM_SH"
        )
        fi

        echo "å¤åˆ¶æ–‡ä»¶..."
        if [ -n "$(ls -A "build/${{matrix.target}}/files" 2>/dev/null)" ]; then
         cp -rf build/${{matrix.target}}/files files
         chmod -R 755 build/${{matrix.target}}/files/* ./
        fi
        if [ -n "$(ls -A "build/${{matrix.target}}/sources" 2>/dev/null)" ]; then
         cp -Rf build/${{matrix.target}}/sources/* ./
        fi

        echo "å†™å…¥é…ç½®æ–‡ä»¶..."
        mv build/${{matrix.target}}/$CONFIG_FILE .config
        make defconfig

    - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨
      uses: P3TERX/ssh2actions@v1.0.0
      if: env.SSH_ACTIONS == 'true' || (github.event.inputs.ssh == 'ssh' && github.event.inputs.ssh  != 'false')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}

    - name: è¾“å‡ºé…ç½®æ–‡ä»¶
      run: |
        cd openwrt && cat .config

    - name: ä¸‹è½½å›ºä»¶åŒ…
      run: |
        cd openwrt && make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(($(nproc)+1)) thread compile"
        make -j$(($(nproc)+1)) || make -j1 V=s

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ
      run: |
        echo "======================="
        echo "Space usage:"
        echo "======================="
        df -hT
        echo "======================="
        du -h --max-depth=1 openwrt/ --exclude=build_dir --exclude=bin
        du -h --max-depth=1 openwrt/build_dir
        du -h --max-depth=1 openwrt/bin

    - name: æ•´ç†å›ºä»¶æ–‡ä»¶
      id: organizer
      run: |
        mkdir -p ./artifact/firmware
        mkdir -p ./artifact/vmware
        mkdir -p ./artifact/package
        mkdir -p ./artifact/buildinfo
        rm -rf $(find openwrt/bin/targets/ -type d -name "packages")
        cp -rf $(find openwrt/bin/packages/ -type f -name "*.ipk") ./artifact/package/
        cp -rf $(find openwrt/bin/targets/ -type f -name "*.buildinfo" -o -name "*.manifest") ./artifact/buildinfo/
        cp -rf $(find openwrt/bin/targets/ -type f -name "*combined*img*") ./artifact/firmware/
        cp -rf $(find openwrt/bin/targets/ -type f -name "*combined*vmdk*") ./artifact/vmware/
        echo "::set-output name=status::success"

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_firmware_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/firmware/

    - name: ä¸Šä¼ vmwareé•œåƒæ–‡ä»¶
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_VMDK == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_vmware_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/vmware/

    - name: ä¸Šä¼ æ’ä»¶åŒ…æ–‡ä»¶
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_IPK == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_package_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/package/

    - name: ä¸Šä¼ å›ºä»¶ä¿¡æ¯
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_CONFIG == 'true'
      uses: actions/upload-artifact@v2
      with:
        name: OpenWrt_buildinfo_${{matrix.target}}_${{ env.FILE_DATE }}
        path: ./artifact/buildinfo/

    - name: ä¸Šä¼ å›ºä»¶åˆ° å¥¶ç‰›å¿«ä¼ 
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_COWTRANSFER == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ./artifact/firmware/ 2>&1 | tee cowtransfer.log
        echo "::warning file=å¥¶ç‰›å¿«ä¼ ï¼ˆ${{matrix.target}}ï¼‰::$(cat cowtransfer.log | grep https)"

    - name: ä¸Šä¼ å›ºä»¶åˆ° WeTransfer
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_WETRANSFER == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ./artifact/firmware/ 2>&1 | tee wetransfer.log
        echo "::warning file=WeTransferï¼ˆ${{matrix.target}}ï¼‰::$(cat wetransfer.log | grep https)"
    
    - name: æå–å‘å¸ƒç”¨çš„ã€Œå¥¶ç‰›å¿«ä¼ ã€å’Œã€ŒWeTransferã€çš„é“¾æ¥
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      run: |
        curl -fsSL git.io/file-transfer | sh
        ./transfer cow --block 2621440 -s -p 64 --no-progress ./artifact/firmware/ 2>&1 | tee cowtransfer.log
        echo "COWTRANSFER_URL=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV 
        curl -fsSL git.io/file-transfer | sh
        ./transfer wet -s -p 16 --no-progress ./artifact/firmware/ 2>&1 | tee wetransfer.log
        echo "WETRANSFER_URL=$(cat wetransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV 

    - name: è‡ªåŠ¨å‘å¸ƒå›ºä»¶åˆ° Releases
      uses: softprops/action-gh-release@v1
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}
      with:
        name: ${{ env.FILE_DATE1 }} ã€Œ ${{ env.FIRMWARE_MESSAGE }} ã€å›ºä»¶
        tag_name: ${{ env.FILE_DATE2 }}-${{matrix.target}}
        body: |            
            â˜†  æºç  : ${{ env.REPO_URL }}
            â˜†  åˆ†æ”¯ : ${{ env.REPO_BRANCH }}
            â˜†  æ„Ÿè°¢æºç ä½œè€…æ— ç§åˆ†äº«ï¼

            ğŸˆ ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_DATE1 }}

            ğŸ‰ [ ${{ env.FIRMWARE_MESSAGE }} ]å›ºä»¶ä¸‹è½½ âœ¨

            ğŸ’ å¥¶ç‰›å¿«ä¼ (å›½å†…é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.COWTRANSFER_URL }}

            â›„ WeTransfer(å›½å¤–é«˜é€ŸğŸš€ä¸‹è½½)ï¼š ${{ env.WETRANSFER_URL }}

            ğŸŒ´ WeTransferé“¾æ¥æœ‰æ•ˆæœŸä¸º7å¤©ï¼Œå¥¶ç‰›å¿«ä¼ ä¸º24å°æ—¶ï¼Œæ— éœ€æ³¨å†Œç›´æ¥ä¸‹è½½ ğŸ¤

            =========================================
            
        files: ./artifact/firmware/*

    - name: åˆ é™¤è¿è¡Œè®°å½•
      uses: db-one/delete-workflow-runs@main
      with:
        retain_days: 30     #ä¿ç•™æœ€åå¤šå°‘è®°å½•ä¸åˆ é™¤
        keep_minimum_runs: 0

    - name: åˆ é™¤è‡ªåŠ¨å‘å¸ƒçš„æ—§å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.1.0
      if: steps.organizer.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true'
      with:
        keep_latest: 20         #ä¿ç•™å¤šå°‘ä¸ªreleasesä¸åˆ é™¤
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GIT_USER_TOKEN }}

    - name: ç¼–è¯‘æˆåŠŸä¿¡æ¯é€šçŸ¥-ä¼ä¸šå¾®ä¿¡
      if: steps.organizer.outputs.status == 'success' && env.WECHAT_WORK_PUSH == 'true'
      run: |
        curl "http://${{ secrets.WECHAT_WORK_URL }}/push?token=${{ secrets.WECHAT_WORK_TOKEN }}&message=æ‚¨çš„${{ env.FIRMWARE_MESSAGE }}å›ºä»¶æˆåŠŸç¼–è¯‘å®Œæˆäº†ï¼%0a%0aç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_DATE1 }}%0a%0aå‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}%0a%0aå¥¶ç‰›å¿«ä¼ ï¼š${{ env.COWTRANSFER_URL }}%0a%0aWeTransferï¼š${{ env.WETRANSFER_URL }}%0a%0aå›ºä»¶å·²ç»ç¼–è¯‘å®ŒæˆğŸˆï¼ï¼ï¼"

    - name: ç¼–è¯‘æˆåŠŸä¿¡æ¯é€šçŸ¥-Telegram
      if: steps.organizer.outputs.status == 'success' && env.TELEGRAM_BOT == 'true'
      run: |
        curl "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}&text=æ‚¨çš„${{ env.FIRMWARE_MESSAGE }}å›ºä»¶æˆåŠŸç¼–è¯‘å®Œæˆäº†ï¼

          ç¼–è¯‘æ—¶é—´ï¼š${{ env.FILE_DATE1 }}

          å‘å¸ƒåœ°å€ï¼š${{ env.GITHUB_RELEASE }}

          å¥¶ç‰›å¿«ä¼ ï¼š${{ env.COWTRANSFER_URL }}

          WeTransferï¼š${{ env.WETRANSFER_URL }}

          å›ºä»¶å·²ç»ç¼–è¯‘å®Œæˆ ğŸˆï¼ï¼ï¼"



